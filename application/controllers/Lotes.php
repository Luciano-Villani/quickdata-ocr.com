<?php

use function PHPSTORM_META\type;
// <!-- {"api_request":{"error":[],"resources":["document"],"status":"success","status_code":201,"url":"https:\/\/api.mindee.net\/v1\/products\/quickdata-mvl\/claro_argentina\/v1\/predict"},"document":{"id":"ad449a29-234b-4406-ad1e-ad94137b43c0","inference":{"extras":[],"finished_at":"2024-03-07T18:31:45.237748","is_rotation_applied":true,"pages":[{"extras":[],"id":0,"orientation":{"value":0},"prediction":{"consumo":{"confidence":0.99,"values":[{"confidence":0.99,"content":"18","polygon":[[0.459,0.248],[0.472,0.248],[0.472,0.255],[0.459,0.255]]}]},"fecha_emision":{"confidence":1,"values":[{"confidence":1,"content":"2024-02-22","polygon":[[0.889,0.047],[0.951,0.047],[0.951,0.054],[0.889,0.054]]}]},"nombre_proveedor":{"confidence":1,"values":[{"confidence":1,"content":"Claro-","polygon":[[0.042,0.052],[0.121,0.051],[0.122,0.068],[0.043,0.069]]}]},"nro_cuenta":{"confidence":0.77,"values":[{"confidence":0.77,"content":"2\/1192806055","polygon":[[0.432,0.229],[0.508,0.229],[0.508,0.236],[0.432,0.236]]}]},"nro_de_cliente":{"confidence":1,"values":[{"confidence":1,"content":"23259917","polygon":[[0.431,0.239],[0.483,0.239],[0.483,0.246],[0.431,0.246]]}]},"numero_de_factura":{"confidence":1,"values":[{"confidence":1,"content":"1326-19529184","polygon":[[0.868,0.037],[0.951,0.037],[0.951,0.044],[0.868,0.044]]}]},"periodo_del_consumo":{"confidence":1,"values":[{"confidence":1,"content":"23\/01\/2024","polygon":[[0.716,0.205],[0.777,0.205],[0.777,0.212],[0.716,0.212]]},{"confidence":0.99,"content":"hasta","polygon":[[0.78,0.205],[0.809,0.205],[0.809,0.212],[0.78,0.212]]},{"confidence":1,"content":"22\/02\/2024","polygon":[[0.812,0.205],[0.873,0.205],[0.873,0.212],[0.812,0.212]]}]},"proximo_vencimiento":{"confidence":1,"values":[{"confidence":1,"content":"2024-04-15","polygon":[[0.731,0.182],[0.809,0.182],[0.809,0.191],[0.731,0.191]]}]},"total_importe":{"confidence":0,"values":[]},"total_vencido":{"confidence":0.99,"values":[{"confidence":0.99,"content":"39.276,55","polygon":[[0.88,0.293],[0.938,0.294],[0.938,0.303],[0.88,0.302]]}]},"vencimiento_del_pago":{"confidence":1,"values":[{"confidence":1,"content":"2024-03-15","polygon":[[0.677,0.169],[0.755,0.169],[0.755,0.177],[0.677,0.177]]}]}}},{"extras":[],"id":1,"orientation":{"value":0},"prediction":{"consumo":{"confidence":0,"values":[]},"fecha_emision":{"confidence":0,"values":[]},"nombre_proveedor":{"confidence":0,"values":[]},"nro_cuenta":{"confidence":0,"values":[]},"nro_de_cliente":{"confidence":0,"values":[]},"numero_de_factura":{"confidence":0,"values":[]},"periodo_del_consumo":{"confidence":0,"values":[]},"proximo_vencimiento":{"confidence":0,"values":[]},"total_importe":{"confidence":0,"values":[]},"total_vencido":{"confidence":0,"values":[]},"vencimiento_del_pago":{"confidence":0,"values":[]}}},{"extras":[],"id":2,"orientation":{"value":0},"prediction":{"consumo":{"confidence":0,"values":[]},"fecha_emision":{"confidence":0,"values":[]},"nombre_proveedor":{"confidence":0,"values":[]},"nro_cuenta":{"confidence":0,"values":[]},"nro_de_cliente":{"confidence":0,"values":[]},"numero_de_factura":{"confidence":0,"values":[]},"periodo_del_consumo":{"confidence":0,"values":[]},"proximo_vencimiento":{"confidence":0,"values":[]},"total_importe":{"confidence":0,"values":[]},"total_vencido":{"confidence":0,"values":[]},"vencimiento_del_pago":{"confidence":0,"values":[]}}}],"prediction":{"consumo":{"confidence":0.99,"values":[{"confidence":0.99,"content":"18","page_id":0,"polygon":[[0.459,0.248],[0.472,0.248],[0.472,0.255],[0.459,0.255]]}]},"fecha_emision":{"confidence":1,"values":[{"confidence":1,"content":"2024-02-22","page_id":0,"polygon":[[0.889,0.047],[0.951,0.047],[0.951,0.054],[0.889,0.054]]}]},"nombre_proveedor":{"confidence":1,"values":[{"confidence":1,"content":"Claro-","page_id":0,"polygon":[[0.042,0.052],[0.121,0.051],[0.122,0.068],[0.043,0.069]]}]},"nro_cuenta":{"confidence":0.77,"values":[{"confidence":0.77,"content":"2\/1192806055","page_id":0,"polygon":[[0.432,0.229],[0.508,0.229],[0.508,0.236],[0.432,0.236]]}]},"nro_de_cliente":{"confidence":1,"values":[{"confidence":1,"content":"23259917","page_id":0,"polygon":[[0.431,0.239],[0.483,0.239],[0.483,0.246],[0.431,0.246]]}]},"numero_de_factura":{"confidence":1,"values":[{"confidence":1,"content":"1326-19529184","page_id":0,"polygon":[[0.868,0.037],[0.951,0.037],[0.951,0.044],[0.868,0.044]]}]},"periodo_del_consumo":{"confidence":1,"values":[{"confidence":1,"content":"23\/01\/2024","page_id":0,"polygon":[[0.716,0.205],[0.777,0.205],[0.777,0.212],[0.716,0.212]]},{"confidence":0.99,"content":"hasta","page_id":0,"polygon":[[0.78,0.205],[0.809,0.205],[0.809,0.212],[0.78,0.212]]},{"confidence":1,"content":"22\/02\/2024","page_id":0,"polygon":[[0.812,0.205],[0.873,0.205],[0.873,0.212],[0.812,0.212]]}]},"proximo_vencimiento":{"confidence":1,"values":[{"confidence":1,"content":"2024-04-15","page_id":0,"polygon":[[0.731,0.182],[0.809,0.182],[0.809,0.191],[0.731,0.191]]}]},"total_importe":{"confidence":0,"values":[]},"total_vencido":{"confidence":0.99,"values":[{"confidence":0.99,"content":"39.276,55","page_id":0,"polygon":[[0.88,0.293],[0.938,0.294],[0.938,0.303],[0.88,0.302]]}]},"vencimiento_del_pago":{"confidence":1,"values":[{"confidence":1,"content":"2024-03-15","page_id":0,"polygon":[[0.677,0.169],[0.755,0.169],[0.755,0.177],[0.677,0.177]]}]}},"processing_time":3.536,"product":{"features":["consumo","fecha_emision","nombre_proveedor","nro_cuenta","nro_de_cliente","numero_de_factura","periodo_del_consumo","proximo_vencimiento","total_importe","total_vencido","vencimiento_del_pago"],"name":"quickdata-mvl\/claro_argentina","type":"constructed","version":"1.1"},"started_at":"2024-03-07T18:31:41.701367"},"n_pages":3,"name":"bill_2.pdf"}} -->


defined('BASEPATH') or exit('No direct script access allowed');

class Lotes extends backend_controller
{
	function __construct()
	{
		parent::__construct();

		// if (!$this->ion_auth->logged_in() || (!$this->ion_auth->is_admin() || !$this->ion_auth->is_super())) {
		if (!$this->ion_auth->logged_in()) {
			redirect('Login');
		} else {

			$this->load->model('manager/Lecturas_model');
			$this->load->model('manager/Uploader_model');
		}
	}

	public function getDato($file = '', $id_proveedor = '')
	{

		if ($this->input->is_ajax_request()) {
			$file = $_REQUEST['file'];
			$id_proveedor = $_REQUEST['id_proveedor'];
		}

		$query = "SELECT id, dato_api FROM _datos_api WHERE nombre_archivo_temp = '" . $file . "'";
		$valor = $file;
		$filename = $file;


		$valor_escapado = $valor;

		$resultado = $this->db->query($query, array($valor_escapado));
		$mires = $resultado->result();


		if ($resultado) {

			$a = json_decode($mires[0]->dato_api);


			switch ($id_proveedor) {


				case 1: // ASYSA - Solo Azure
			// Extraer datos directamente del JSON de Azure
			$fields = $a[0]->fields; // El JSON está en un array, accedemos a la posición 0

			// --- Fechas ---
			$fecha_emision = isset($fields->fecha_emision->valueDate) ? trim($fields->fecha_emision->valueDate) : 'S/D';
			$vencimiento_del_pago = isset($fields->vencimiento_del_pago->valueDate) ? trim($fields->vencimiento_del_pago->valueDate) : 'S/D';

			// --- Otros campos principales ---
			$nro_cuenta = isset($fields->nro_cuenta->content) ? trim($fields->nro_cuenta->content) : 'S/D';
			$nro_factura = isset($fields->nro_factura->content) ? trim($fields->nro_factura->content) : 'S/D';
			$periodo_del_consumo = isset($fields->periodo_del_consumo->content) ? trim($fields->periodo_del_consumo->content) : 'S/D';
			$total_importe_raw = isset($fields->total_importe->content) ? trim($fields->total_importe->content) : '0,00';
			$total_vencido_raw = isset($fields->total_vencido->content) ? trim($fields->total_vencido->content) : '0,00';

			// --- Campos opcionales ---
			$nro_medidor = (isset($fields->nro_medidor->content) && trim($fields->nro_medidor->content) !== '') 
				? trim($fields->nro_medidor->content) 
				: 'N/A';

			$consumo = (isset($fields->consumo->content) && trim($fields->consumo->content) !== '') 
				? trim($fields->consumo->content) 
				: 'N/A';

			// --- Limpieza y formateo de importes ---
			// Ejemplo: "50.785,21" -> "50785.21"
			$total_importe_clean = str_replace('.', '', $total_importe_raw);
			$total_importe_clean = str_replace(',', '.', $total_importe_clean);

			$total_vencido_clean = str_replace('.', '', $total_vencido_raw);
			$total_vencido_clean = str_replace(',', '.', $total_vencido_clean);

			$importe_1_formatted = is_numeric($total_importe_clean) 
				? number_format((float)$total_importe_clean, 2, '.', '') 
				: '0.00';

			// --- Calcular mes y año desde fecha_emision ---
			$fecha_emision_para_calculo = trim($fecha_emision);
			$mes_fc = '';
			$anio_fc = '';
			if ($fecha_emision_para_calculo !== 'S/D') {
				$mesAnioData = $this->getMesAnioDesdeFecha($fecha_emision_para_calculo);
				$mes_fc = $mesAnioData['mes_fc'];
				$anio_fc = $mesAnioData['anio_fc'];
			}

			// --- Construcción del array final ---
			$dataUpdate = array(
				'nro_cuenta'          => $nro_cuenta,
				'nro_medidor'         => $nro_medidor,
				'nro_factura'         => $nro_factura,
				'periodo_del_consumo' => $periodo_del_consumo,
				'fecha_emision'       => $fecha_emision,
				'vencimiento_del_pago'=> $vencimiento_del_pago,
				'total_importe'       => $total_importe_clean,    // Valor limpio con punto decimal
				'importe_1'           => $importe_1_formatted,    // Valor final formateado
				'total_vencido'       => $total_vencido_clean,
				'monto_subsidio'      => isset($fields->monto_subsidio->content) ? trim($fields->monto_subsidio->content) : 'N/A',
				'consumo'             => $consumo,
				'mes_fc'              => $mes_fc,
				'anio_fc'             => $anio_fc,
			);

			// --- Debug opcional ---
			log_message('debug', 'Datos procesados para Azure - ASYSA: ' . json_encode($dataUpdate));

			break;

					
					case 2: // NATURGY 4399 azure

				// Verificamos que existan datos en el JSON
				if (isset($a[0]->fields)) {
					$fields = $a[0]->fields;

					//$nro_cuenta = isset($fields->nro_cuenta->content) ? trim($fields->nro_cuenta->content) : 'S/D';
					$nro_cuenta = isset($fields->nro_cuenta->content) ? str_replace(' ', '', trim($fields->nro_cuenta->content)) : 'S/D';
					$nro_medidor = isset($fields->nro_medidor->valueNumber) ? trim($fields->nro_medidor->valueNumber) : 'S/D';
					$nro_factura = isset($fields->nro_factura->valueNumber) ? trim($fields->nro_factura->valueNumber) : 'S/D';
					//$periodo_del_consumo = isset($fields->periodo_del_consumo->valueString) ? trim($fields->periodo_del_consumo->valueString) : 'S/D';
					$fecha_emision = isset($fields->fecha_emision->valueDate) ? trim($fields->fecha_emision->valueDate) : 'S/D';
					$vencimiento_del_pago = isset($fields->vencimiento_del_pago->valueDate) ? trim($fields->vencimiento_del_pago->valueDate) : 'S/D';
					$proximo_vencimiento = isset($fields->proximo_vencimiento->valueDate) ? trim($fields->proximo_vencimiento->valueDate) : 'S/D';
					$consumo = isset($fields->consumo->content) ? trim($fields->consumo->content) : '0.00';
					
					// total_importe ya se extrae y formatea a 2 decimales
					$total_importe = isset($fields->total_importe->valueNumber) ? number_format($fields->total_importe->valueNumber, 2, '.', '') : '0.00';
					
					$total_vencido = isset($fields->total_vencido->valueNumber) ? number_format($fields->total_vencido->valueNumber, 2, '.', '') : '0.00';

					// Extraer solo la parte antes del guion "-"
					$periodo_del_consumo = isset($fields->periodo_del_consumo->valueString) ? trim($fields->periodo_del_consumo->valueString) : 'S/D';
					$periodo_del_consumo = explode('-', $periodo_del_consumo)[0]; // Toma solo la parte antes del "-"

					// Lógica para obtener mes_fc y anio_fc
					$mesAnioData = $this->getMesAnioDesdeFecha($fecha_emision);

					$dataUpdate = array(
						'nro_cuenta'         => $nro_cuenta,
						'nro_medidor'        => $nro_medidor,
						'nro_factura'        => $nro_factura,
						'periodo_del_consumo' => $periodo_del_consumo,
						'fecha_emision'      => $fecha_emision,
						'vencimiento_del_pago' => $vencimiento_del_pago,
						'proximo_vencimiento' => $proximo_vencimiento,
						'consumo'            => $consumo,
						'total_importe'      => $total_importe,
						'importe_1'          => $total_importe, // <--- AGREGADO: Utiliza el mismo valor de total_importe ya formateado
						'total_vencido'      => $total_vencido,
						'mes_fc'             => $mesAnioData['mes_fc'],
						'anio_fc'            => $mesAnioData['anio_fc'],
					);
				} else {
					// Manejar el caso en el que no haya datos en el JSON
					$dataUpdate = array(
						'nro_cuenta'         => 'S/D',
						'nro_medidor'        => 'S/D',
						'nro_factura'        => 'S/D',
						'periodo_del_consumo' => 'S/D',
						'fecha_emision'      => 'S/D',
						'vencimiento_del_pago' => 'S/D',
						'proximo_vencimiento' => 'S/D',
						'consumo'            => '0.00',
						'total_importe'      => '0.00',
						'importe_1'          => '0.00', // <--- AGREGADO: Valor por defecto para importe_1
						'total_vencido'      => '0.00',
						'mes_fc'             => 'S/D',
						'anio_fc'            => 'S/D',
					);
				}

				break;
					
					
				case 3: // FLOW 3480 azure

				if (isset($a[0]->fields)) {
					$fields = $a[0]->fields;

					$nro_cuenta = isset($fields->nro_cuenta->valueNumber) ? trim($fields->nro_cuenta->valueNumber) : 'S/D';
					$nro_factura = isset($fields->numero_de_factura->valueString) ? trim($fields->numero_de_factura->valueString) : 'S/D';
					$fecha_emision = isset($fields->fecha_emision->valueDate) ? trim($fields->fecha_emision->valueDate) : 'S/D';
					
					// total_importe ya se extrae y formatea a 2 decimales
					$total_importe = isset($fields->total_importe->valueNumber) ? number_format($fields->total_importe->valueNumber, 2, '.', '') : '0.00';
					
					$vencimiento_del_pago = isset($fields->vencimiento_del_pago->valueDate) ? trim($fields->vencimiento_del_pago->valueDate) : 'S/D';
					$periodo_del_consumo = isset($fields->periodo_del_consumo->valueString) ? trim($fields->periodo_del_consumo->valueString) : 'S/D';

					$abonos = isset($fields->abonos->valueString) ? trim($fields->abonos->valueString) : '';
					$cantidad_abonos = isset($fields->cantidad_de_abonos->valueNumber) ? trim($fields->cantidad_de_abonos->valueNumber) : '';
					$consumo = (!empty($abonos) && $cantidad_abonos !== '') ? $abonos . ' x ' . $cantidad_abonos : 'S/D';

					// *** AQUI APLICAMOS LA LOGICA PARA mes_fc y anio_fc ***
					// Utilizamos la función getMesAnioDesdeFecha con la $fecha_emision ya extraída.
					$mesAnioData = $this->getMesAnioDesdeFecha($fecha_emision);

					$dataUpdate = array(
						'nro_cuenta'         => $nro_cuenta,
						'nro_factura'        => $nro_factura,
						'fecha_emision'      => $fecha_emision,
						'total_importe'      => $total_importe,
						'importe_1'          => $total_importe, // <--- AGREGADO: Utiliza el mismo valor de total_importe ya formateado
						'vencimiento_del_pago' => $vencimiento_del_pago,
						'periodo_del_consumo' => $periodo_del_consumo,
						'consumo'            => $consumo,
						'nro_medidor'        => 'N/A', // Valor fijo para mantener estructura
						'total_vencido'      => 'S/D', // Valor fijo para mantener estructura
						'mes_fc'             => $mesAnioData['mes_fc'],
						'anio_fc'            => $mesAnioData['anio_fc'],
					);
				} else {
					$dataUpdate = array(
						// Es buena práctica inicializar todos los campos con valores por defecto aquí también
						'nro_cuenta'         => 'S/D',
						'nro_factura'        => 'S/D',
						'fecha_emision'      => 'S/D',
						'total_importe'      => '0.00',
						'importe_1'          => '0.00', // <--- AGREGADO: Valor por defecto para importe_1
						'vencimiento_del_pago' => 'S/D',
						'periodo_del_consumo' => 'S/D',
						'consumo'            => 'S/D',
						'nro_medidor'        => 'N/A',
						'total_vencido'      => 'S/D',
						'mes_fc'             => 'S/D',
						'anio_fc'            => 'S/D',
					);
				}
				break;


							case 4: //3857 EDENOR

    // Verificar si el JSON de Azure tiene el campo 'fields' antes de procesar.
    if (isset($a[0]->fields)) {
        $fields = $a[0]->fields;

        // Extraer y limpiar cada campo con validación `isset()`
        $nro_cuenta_raw = isset($fields->nro_cuenta->content) ? trim($fields->nro_cuenta->content) : 'S/D';
        $nro_cuenta_limpio = str_replace(' ', '', $nro_cuenta_raw);

        $nro_medidor = isset($fields->nro_medidor->content) ? trim($fields->nro_medidor->content) : 'N/A';
        $nro_factura = isset($fields->nro_de_factura->valueString) ? trim($fields->nro_de_factura->valueString) : 'S/D';

        // Fechas con `valueDate`
        $fecha_emision = isset($fields->fecha_emision->valueDate) ? trim($fields->fecha_emision->valueDate) : 'S/D';
        $vencimiento_del_pago = isset($fields->vencimiento_del_pago->valueDate) ? trim($fields->vencimiento_del_pago->valueDate) : 'S/D';
        $proximo_vencimiento = isset($fields->proximo_vencimiento->valueDate) ? trim($fields->proximo_vencimiento->valueDate) : 'S/D';

        $periodo_del_consumo = isset($fields->periodo_del_consumo->content) ? trim($fields->periodo_del_consumo->content) : 'S/D';
        $consumo = isset($fields->consumo->content) ? trim($fields->consumo->content) : 'S/D';
        $total_vencido = isset($fields->total_vencido->content) ? trim($fields->total_vencido->content) : 'S/D';

        // Lógica para total_importe e importe_1, adaptada para el formato de Edenor
        $total_importe_json_string = isset($fields->total_importe->content) ? trim($fields->total_importe->content) : '0,00';
        $total_importe_cleaned_string = str_replace('.', '', $total_importe_json_string); // Elimina puntos
        $total_importe_cleaned_string = str_replace(',', '.', $total_importe_cleaned_string); // Reemplaza coma por punto

        $total_importe = '0.00';
        if (is_numeric($total_importe_cleaned_string)) {
            $total_importe = number_format((float)$total_importe_cleaned_string, 2, '.', '');
        }
        $importe_1 = $total_importe; // Se usa el mismo valor formateado para importe_1

        // Lógica para mes_fc y anio_fc
        $mesAnioData = $this->getMesAnioDesdeFecha($fecha_emision);

        $dataUpdate = array(
            'nro_cuenta'           => $nro_cuenta_limpio,
            'nro_medidor'          => $nro_medidor,
            'nro_factura'          => $nro_factura,
            'periodo_del_consumo'  => $periodo_del_consumo,
            'fecha_emision'        => $fecha_emision,
            'vencimiento_del_pago' => $vencimiento_del_pago,
            'proximo_vencimiento'  => $proximo_vencimiento,
            'total_importe'        => $total_importe,
            'importe_1'            => $importe_1,
            'consumo'              => $consumo,
            'total_vencido'        => $total_vencido,
            'mes_fc'               => $mesAnioData['mes_fc'],
            'anio_fc'              => $mesAnioData['anio_fc'],
        );
    } else {
        // Bloque else para valores por defecto si no se encuentran los campos
        $dataUpdate = array(
            'nro_cuenta'           => 'S/D',
            'nro_medidor'          => 'N/A',
            'nro_factura'          => 'S/D',
            'periodo_del_consumo'  => 'S/D',
            'fecha_emision'        => 'S/D',
            'vencimiento_del_pago' => 'S/D',
            'proximo_vencimiento'  => 'S/D',
            'total_importe'        => '0.00',
            'importe_1'            => '0.00',
            'consumo'              => 'S/D',
            'total_vencido'        => 'S/D',
            'mes_fc'               => 'S/D',
            'anio_fc'              => 'S/D',
        );
    }
    break;

				case 5: //3480 PERSONAL

						$totalIndices = count($a->document->inference->pages[0]->prediction->periodo_del_consumo->values);
						$periodo_del_consumo = '';
						for ($paso = 0; $paso < $totalIndices; $paso++) {
							$periodo_del_consumo .= ' ' . $a->document->inference->pages[0]->prediction->periodo_del_consumo->values[$paso]->content;
						}
						$totalIndices = count($a->document->inference->pages[0]->prediction->numero_de_factura->values);
						$numero_de_factura = '';
						for ($paso = 0; $paso < $totalIndices; $paso++) {
							$numero_de_factura .= ' ' . $a->document->inference->pages[0]->prediction->numero_de_factura->values[$paso]->content;
						}

						// --- INICIO: Lógica para mes_fc y anio_fc ---
						// Extraer fecha_emision a una variable para poder usarla en la función
						$fecha_emision_raw = trim($a->document->inference->pages[0]->prediction->fecha_emision->values[0]->content);
						$mesAnioData = $this->getMesAnioDesdeFecha($fecha_emision_raw);
						// --- FIN: Lógica para mes_fc y anio_fc ---

						// --- INICIO: Lógica para total_importe e importe_1 ---
						$cargos_del_mes_raw_string = trim($a->document->inference->pages[0]->prediction->cargos_del_mes->values[0]->content);
						
						// Limpiar el string: remover comas (asumiendo que los puntos son decimales o no existen)
						$cargos_del_mes_cleaned_string = str_replace(',', '', $cargos_del_mes_raw_string); 

						$importe_1_personal_formatted = '0.00';
						if (is_numeric($cargos_del_mes_cleaned_string)) {
							$importe_1_personal_formatted = number_format((float)$cargos_del_mes_cleaned_string, 2, '.', '');
						}
						// --- FIN: Lógica para total_importe e importe_1 ---


						$dataUpdate = array(
							'vencimiento_del_pago' => trim($a->document->inference->pages[0]->prediction->vencimiento_del_pago->values[0]->content),
							'periodo_del_consumo' => trim($periodo_del_consumo),
							'nro_cuenta' => trim($a->document->inference->pages[0]->prediction->nro_cuenta->values[0]->content),
							'nro_factura' => trim($numero_de_factura),
							'fecha_emision' => $fecha_emision_raw, // Usamos la variable ya extraída
							'total_importe' => $cargos_del_mes_cleaned_string, // Ahora es el string limpio
							'importe_1' => $importe_1_personal_formatted, // <--- AGREGADO: El valor formateado a 2 decimales
							'proximo_vencimiento' => trim($a->document->inference->pages[0]->prediction->proximo_vencimiento->values[0]->content),
							'total_vencido' => trim('S/D'),
							'consumo' => trim('Plan Internet'),
							'nro_medidor' => trim('N/A'),
							'mes_fc' => $mesAnioData['mes_fc'],   // <--- Agregado
							'anio_fc' => $mesAnioData['anio_fc'], // <--- Agregado
						);
						break;
					
				case 6: // 6198 CLARO ARGENTINA - Azure

						// Verificamos que existan datos en el JSON en la ruta de Azure
						if (isset($a[0]->fields)) {
							$fields = $a[0]->fields;

							// Extraemos cada campo necesario, validando y formateando
							$nro_cuenta = isset($fields->nro_cuenta->valueString) ? trim($fields->nro_cuenta->valueString) : 'N/A';
							$periodo_del_consumo = isset($fields->periodo_del_consumo->valueString) ? trim($fields->periodo_del_consumo->valueString) : 'N/A';
							$consumo = isset($fields->consumo->valueNumber) ? number_format($fields->consumo->valueNumber, 2, '.', '') : '0.00';
							$numero_de_factura = isset($fields->numero_de_factura->valueString) ? trim($fields->numero_de_factura->valueString) : 'N/A';
							$fecha_emision = isset($fields->fecha_emision->valueDate) ? trim($fields->fecha_emision->valueDate) : 'N/A';
							$vencimiento_del_pago = isset($fields->vencimiento_del_pago->valueDate) ? trim($fields->vencimiento_del_pago->valueDate) : 'N/A';
							$proximo_vencimiento = isset($fields->proximo_vencimiento->valueDate) ? trim($fields->proximo_vencimiento->valueDate) : 'N/A';
							$total_importe = isset($fields->total_importe->valueNumber) ? number_format($fields->total_importe->valueNumber, 2, '.', '') : '0.00';
							$total_vencido = '0.00'; // Este campo no está en el JSON de ejemplo, por lo tanto, lo dejamos en 0.00

							// Asignamos el total_importe como importe_1, como lo tenías antes
							$importe_1 = $total_importe;

							// Extraemos mes y año de la fecha de emisión
							$mes_fc = '0';
							$anio_fc = '0';
							if ($fecha_emision !== 'N/A') {
								$fecha_objeto = new DateTime($fecha_emision);
								$mes_fc = $fecha_objeto->format('m');
								$anio_fc = $fecha_objeto->format('Y');
							}

							$dataUpdate = array(
								'periodo_del_consumo' => $periodo_del_consumo,
								'nro_cuenta' => $nro_cuenta,
								'nro_medidor' => 'N/A', // No está en el JSON, lo dejamos como N/A
								'nro_factura' => $numero_de_factura,
								'fecha_emision' => $fecha_emision,
								'vencimiento_del_pago' => $vencimiento_del_pago,
								'proximo_vencimiento' => $proximo_vencimiento,
								'total_vencido' => $total_vencido,
								'total_importe' => $total_importe,
								'importe_1' => $importe_1,
								'consumo' => $consumo,
								'mes_fc' => $mes_fc,
								'anio_fc' => $anio_fc,
								// Agrega otros campos que no estén en el JSON, si es necesario, con valores por defecto
							);
							
						} else {
							// Manejar el caso en el que no haya datos en la respuesta de Azure
							$dataUpdate = array(); 
						}
						break;


					case 12: // telmex - Azure

						// Verificamos que existan datos en el JSON en la ruta de Azure
						if (isset($a[0]->fields)) {
							$fields = $a[0]->fields;

							// Extraemos cada campo necesario, validando y formateando
							$nro_cuenta = isset($fields->nro_cuenta->valueString) ? trim($fields->nro_cuenta->valueString) : 'N/A';
							$periodo_del_consumo = isset($fields->periodo_del_consumo->valueString) ? trim($fields->periodo_del_consumo->valueString) : 'N/A';
							$consumo = isset($fields->consumo->valueNumber) ? number_format($fields->consumo->valueNumber, 2, '.', '') : '0.00';
							$numero_de_factura = isset($fields->numero_de_factura->valueString) ? trim($fields->numero_de_factura->valueString) : 'N/A';
							$fecha_emision = isset($fields->fecha_emision->valueDate) ? trim($fields->fecha_emision->valueDate) : 'N/A';
							$vencimiento_del_pago = isset($fields->vencimiento_del_pago->valueDate) ? trim($fields->vencimiento_del_pago->valueDate) : 'N/A';
							$proximo_vencimiento = isset($fields->proximo_vencimiento->valueDate) ? trim($fields->proximo_vencimiento->valueDate) : 'N/A';
							$total_importe = isset($fields->total_importe->valueNumber) ? number_format($fields->total_importe->valueNumber, 2, '.', '') : '0.00';
							$total_vencido = '0.00'; // Este campo no está en el JSON de ejemplo, por lo tanto, lo dejamos en 0.00

							// Asignamos el total_importe como importe_1, como lo tenías antes
							$importe_1 = $total_importe;

							// Extraemos mes y año de la fecha de emisión
							$mes_fc = '0';
							$anio_fc = '0';
							if ($fecha_emision !== 'N/A') {
								$fecha_objeto = new DateTime($fecha_emision);
								$mes_fc = $fecha_objeto->format('m');
								$anio_fc = $fecha_objeto->format('Y');
							}

							$dataUpdate = array(
								'periodo_del_consumo' => $periodo_del_consumo,
								'nro_cuenta' => $nro_cuenta,
								'nro_medidor' => 'N/A', // No está en el JSON, lo dejamos como N/A
								'nro_factura' => $numero_de_factura,
								'fecha_emision' => $fecha_emision,
								'vencimiento_del_pago' => $vencimiento_del_pago,
								'proximo_vencimiento' => $proximo_vencimiento,
								'total_vencido' => $total_vencido,
								'total_importe' => $total_importe,
								'importe_1' => $importe_1,
								'consumo' => $consumo,
								'mes_fc' => $mes_fc,
								'anio_fc' => $anio_fc,
								// Agrega otros campos que no estén en el JSON, si es necesario, con valores por defecto
							);
							
						} else {
							// Manejar el caso en el que no haya datos en la respuesta de Azure
							$dataUpdate = array(); 
						}
						break;



					case 7: // TELECENTRO 3959 (Azure)

				// Verificamos que existan datos en el JSON
				if (isset($a[0]->fields)) {
					$fields = $a[0]->fields;

					// Extraemos los campos principales
					$fecha_emision = isset($fields->fecha_emision->valueDate) ? trim($fields->fecha_emision->valueDate) : 'S/D';
					$vencimiento_del_pago = isset($fields->vencimiento_del_pago->valueDate) ? trim($fields->vencimiento_del_pago->valueDate) : 'S/D';
					$nro_cuenta = isset($fields->nro_cuenta->valueString) ? trim($fields->nro_cuenta->valueString) : 'S/D';
					$nro_factura = isset($fields->nro_factura->valueString) ? trim($fields->nro_factura->valueString) : 'S/D';
					$periodo_del_consumo = isset($fields->periodo_del_consumo->valueString) ? trim($fields->periodo_del_consumo->valueString) : 'S/D';

					// --- Lógica para total_importe e importe_1 ---
					// Azure ya provee el valor numérico en `valueNumber`.
					$total_importe_float = isset($fields->total_importe->valueNumber) ? $fields->total_importe->valueNumber : 0.00;
					
					// Formateamos el importe a 2 decimales con punto como separador.
					$total_importe_formatted = number_format($total_importe_float, 2, '.', '');
					$importe_1 = $total_importe_formatted;
					// --- FIN: Lógica para total_importe e importe_1 ---

					// --- Lógica para mes_fc y anio_fc ---
					$mesAnioData = $this->getMesAnioDesdeFecha($fecha_emision);
					// --- FIN: Lógica para mes_fc y anio_fc ---

					// Asignación de valores a dataUpdate
					$dataUpdate = array(
						'nro_cuenta' => $nro_cuenta,
						'fecha_emision' => $fecha_emision,
						'total_importe' => $total_importe_formatted,
						'importe_1' => $importe_1,
						'nro_factura' => $nro_factura,
						'periodo_del_consumo' => str_replace(':', '', $periodo_del_consumo),
						'vencimiento_del_pago' => $vencimiento_del_pago,
						'nro_medidor' => 'N/A',
						'total_vencido' => 'S/D',
						'consumo' => 'Tel/Int Pyme corp.',
						'mes_fc' => $mesAnioData['mes_fc'],
						'anio_fc' => $mesAnioData['anio_fc'],
					);

					// Lógica de "No Leído" para nro_factura
					if (empty($dataUpdate['nro_factura']) || strlen($dataUpdate['nro_factura']) < 4) {
						$dataUpdate['nro_factura'] = 'No Leído';
					}
				} else {
					// Manejar el caso en que no haya datos en el JSON
					$dataUpdate = array(
						'nro_cuenta' => 'S/D',
						'nro_factura' => 'S/D',
						'fecha_emision' => 'S/D',
						'vencimiento_del_pago' => 'S/D',
						'periodo_del_consumo' => 'S/D',
						'total_importe' => '0.00',
						'importe_1' => '0.00',
						'nro_medidor' => 'N/A',
						'total_vencido' => 'S/D',
						'consumo' => 'S/D',
						'mes_fc' => 'S/D',
						'anio_fc' => 'S/D',
					);
				}

				break;
				case 8: // TELECOM INTERNET - DIGITAL (Azure)

    // Verifica que el JSON de Azure contenga datos en el array principal.
    if (isset($a[0]->fields)) {
        $fields = $a[0]->fields;

        // Extrae los campos principales. Usa el operador ternario para mayor seguridad.
        $nro_cuenta_raw = isset($fields->nro_cuenta->valueString) ? trim($fields->nro_cuenta->valueString) : 'S/D';
        $nro_de_factura = isset($fields->nro_de_factura->valueString) ? trim($fields->nro_de_factura->valueString) : 'S/D';
        $periodo_del_consumo_raw = isset($fields->priodo_del_consumo->valueString) ? trim($fields->priodo_del_consumo->valueString) : 'S/D';
        $fecha_emision_raw = isset($fields->fecha_emision->valueDate) ? trim($fields->fecha_emision->valueDate) : 'S/D';
        $vencimiento_del_pago_raw = isset($fields->vencimiento_del_pago->valueDate) ? trim($fields->vencimiento_del_pago->valueDate) : 'S/D';
        $detalle_de_servicio = isset($fields->detalle_de_servicio->valueString) ? trim($fields->detalle_de_servicio->valueString) : 'S/D';

        // --- INICIO: Lógica para nro_cuenta (Corregida y Simplificada) ---
        // Tu JSON de ejemplo ya trae un formato "169539: 20342". Podemos limpiarlo directamente.
        $nro_cuenta = str_replace(': ', ':', $nro_cuenta_raw);
        // Ejemplo: "169539: 20342" -> "16953920342"
        // Si el formato es estricto, puedes seguir usando la regex, pero esta es más simple.
        // --- FIN: Lógica para nro_cuenta ---

        // --- INICIO: Lógica para total_importe y importe_1 ---
        $total_importe_float = isset($fields->total_importe->valueNumber) ? $fields->total_importe->valueNumber : 0.00;
        $total_importe_formatted = number_format($total_importe_float, 2, '.', '');
        $importe_1 = $total_importe_formatted;
        // --- FIN: Lógica para total_importe y importe_1 ---

        // --- INICIO: Lógica para mes_fc y anio_fc ---
        $mesAnioData = $this->getMesAnioDesdeFecha($fecha_emision_raw);
        // --- FIN: Lógica para mes_fc y anio_fc ---

        // Asignación de valores al array de actualización
        $dataUpdate = array(
            'nro_cuenta'          => $nro_cuenta,
            'nro_medidor'         => 'N/A',
            'nro_factura'         => $nro_de_factura,
            'periodo_del_consumo' => $periodo_del_consumo_raw,
            'fecha_emision'       => $fecha_emision_raw,
            'vencimiento_del_pago' => $vencimiento_del_pago_raw,
            'total_importe'       => $total_importe_formatted,
            'importe_1'           => $importe_1,
            'consumo'             => $detalle_de_servicio,
            'total_vencido'       => 'S/D',
            'mes_fc'              => $mesAnioData['mes_fc'],
            'anio_fc'             => $mesAnioData['anio_fc'],
        );

    } else {
        // Maneja el caso de que no haya datos válidos.
        $dataUpdate = array(
            'nro_cuenta'          => 'S/D',
            'nro_factura'         => 'S/D',
            'fecha_emision'       => 'S/D',
            'vencimiento_del_pago' => 'S/D',
            'periodo_del_consumo' => 'S/D',
            'total_importe'       => '0.00',
            'importe_1'           => '0.00',
            'nro_medidor'         => 'N/A',
            'total_vencido'       => 'S/D',
            'consumo'             => 'S/D',
            'mes_fc'              => 'S/D',
            'anio_fc'             => 'S/D',
        );
    }
    
    break;


				case 10: // 3480 TELECOM TELEFONIA FIJA
					$dataUpdate = (isset($a[0]->fields))
						? $this->procesarProveedorTelecomFija($a[0]->fields)
						: [];
					break;

				case 24: // electro T1 azure

					// Inicialización de variables
					$importe = '';
					$periodo_del_consumo = '';
					$medidor = 'N/A';
					$nro_cuenta = 'N/A';
					$nro_factura = 'N/A';
					$fecha_emision = 'N/A';
					$vencimiento_del_pago = 'N/A';
					$consumo = 'S/D';

					// Comprobación si $a[0] existe y tiene la propiedad 'fields'
					if (isset($a[0]->fields)) {

						// Extraer el importe
						$fields = $a[0]->fields;

						// Extraer el importe, convertir a formato decimal con 2 decimales
						if (isset($fields->total_importe->content)) {
							$importe = trim($fields->total_importe->content);
							$importe = str_replace('.', '', $importe); // Eliminar los puntos como separadores de miles
							$importe = str_replace(',', '.', $importe); // Reemplazar la coma por punto decimal
							$numero_decimal = number_format(floatval($importe), 2, '.', ''); // Convertir a formato decimal con 2 decimales
						} else {
							$numero_decimal = '0.00'; // Valor por defecto en caso de fallo
						}

						// Extraer el periodo del consumo
						$periodo_del_consumo = isset($fields->periodo_del_consumo->content) ? trim($fields->periodo_del_consumo->content) : '';

						// Extraer otros campos y eliminar espacios en números
						$medidor = isset($fields->nro_medidor->content) ? str_replace(' ', '', trim($fields->nro_medidor->content)) : 'N/A';
						$nro_cuenta = isset($fields->nro_cuenta->content) ? str_replace(' ', '', trim($fields->nro_cuenta->content)) : 'N/A';
						$nro_factura = isset($fields->nro_de_factura->content) ? str_replace(' ', '', trim($fields->nro_de_factura->content)) : 'N/A';
						$fecha_emision = isset($fields->fecha_emision->content) ? trim($fields->fecha_emision->content) : 'N/A';
						$vencimiento_del_pago = isset($fields->vencimiento_del_pago->content) ? trim($fields->vencimiento_del_pago->content) : 'N/A';
						$consumo = isset($fields->consumo->content) ? trim($fields->consumo->content) : 'S/D';

						// Otros campos que podrías usar en el futuro
						// $ajustes = isset($fields->ajustes->content) ? trim($fields->ajustes->content) : 'N/A';
						// $domicilio_de_consumo = isset($fields->domicilio_de_consumo->content) ? trim($fields->domicilio_de_consumo->content) : 'N/A';
						// $dias_comprendidos = isset($fields->dias_comprendidos->content) ? trim($fields->dias_comprendidos->content) : 'N/A';
						// $consumo_dias_comprendidos = isset($fields->consumo_dias_comprendidos->content) ? trim($fields->consumo_dias_comprendidos->content) : 'N/A';

					} else {
						// Manejar el caso donde $a[0]->fields no existe
						// Puedes asignar valores por defecto o manejar el error de otra manera aquí
						$numero_decimal = '0.00'; // Valor por defecto en caso de fallo
					}

					// Preparar el array de actualización
					$dataUpdate = array(
						'nro_cuenta' => $nro_cuenta,
						'nro_medidor' => $medidor,
						'nro_factura' => $nro_factura,
						'periodo_del_consumo' => $periodo_del_consumo,
						'fecha_emision' => $fecha_emision,
						'vencimiento_del_pago' => $vencimiento_del_pago,
						'total_importe' => $numero_decimal,
						'importe_1' => $numero_decimal,
						'consumo' => $consumo,
						'total_vencido' => 'S/D', // Asignación fija para este caso
					);

					break;
				case 25: //3857 EDENOR 

					$importe = trim($a->document->inference->pages[0]->prediction->total_importe->values[0]->content);


					$importe = str_replace(',', '.', str_replace('.', '', $importe));




					$numero_decimal = number_format($importe, 2, '.', '');

					$totalIndices = count($a->document->inference->pages[0]->prediction->periodo_del_consumo->values);
					$periodo_del_consumo = '';
					for ($paso = 0; $paso < $totalIndices; $paso++) {
						$periodo_del_consumo .= ' ' . $a->document->inference->pages[0]->prediction->periodo_del_consumo->values[$paso]->content;
					}
					if ($a->document->inference->pages[0]->prediction->nro_medidor->values) {
						$medidor = $a->document->inference->pages[0]->prediction->nro_medidor->values[0]->content;
					} else {
						$medidor = 'N/A';
					}

					if ($a->document->inference->pages[0]->prediction->nro_factura->values) {
						$nro_factura = $a->document->inference->pages[0]->prediction->nro_factura->values[0]->content;
					} else {
						$nro_factura = 'N/A';
					}


					$dataUpdate = array(
						'nro_cuenta' => trim($a->document->inference->pages[0]->prediction->nro_cuenta->values[0]->content),
						'nro_medidor' => trim($medidor),
						'nro_factura' => trim($nro_factura),
						'periodo_del_consumo' => trim($periodo_del_consumo),
						'fecha_emision' => trim($a->document->inference->pages[0]->prediction->fecha_emision->values[0]->content),
						'vencimiento_del_pago' => trim($a->document->inference->pages[0]->prediction->vencimiento_del_pago->values[0]->content),
						'total_importe' => $numero_decimal,
						'importe_1' => $numero_decimal,
						'consumo' => trim($a->document->inference->pages[0]->prediction->consumo->values[0]->content),
						'total_vencido' => trim('S/D'),
					);
					break;
			}


			// Obtener datos del proveedor
$data_proveedor = $this->Manager_model->getwhere('_proveedores', 'id="' . $id_proveedor . '"');
$dataUpdate['unidad_medida'] = $data_proveedor->unidad_medida;



// Guardar en la base de datos
$this->db->where('id', $mires[0]->id);
$this->db->update('_datos_api', $dataUpdate);

}
	}
	public function delete_lote()
	{
		$archivos = $this->Lotes_model->getBatchFiles($_REQUEST['code']);
		$total = 0;
		foreach ($archivos as $data) {
			if (is_file($data->nombre_archivo)) {
				if (unlink($data->nombre_archivo)) {
					$total++;
					$this->db->where('nombre_archivo', $data->nombre_archivo);
					$this->db->delete('_datos_api');
				}
			} else {
				$this->db->where('nombre_archivo', $data->nombre_archivo);
				$this->db->delete('_datos_api');
				// die('no');
			}
		}
		$this->db->where('code', $_REQUEST['code']);
		$this->db->delete('_lotes');

		$response = array(
			'mensaje' => "Archivos borrados",
			'title' => 'LOTES ',
			'status' => 'success'
		);
		echo json_encode($response);
	}


	public function Buscar_archivos($lote, $proveedor)
	{

		if ($this->input->is_ajax_request()) {

			$proveedor = $this->Manager_model->getwhere('_proveedores', 'id="' . $proveedor . '"');

			$files = $this->Lotes_model->getBatchFiles($lote);



			$response = array(
				'mensaje' => 'Listado de archivos a leer',
				'files' => $files,
				'title' => 'Lectuas API',
				'status' => 'success',
			);
			echo json_encode($response);
			exit();
		}
	}

	public function leerApi2()
	{


		$response = array(
			'mensaje' =>  $_REQUEST['file'],
			'title' => 'Consulta API',
			'status' => 'error',
		);

		sleep(3);
		echo json_encode($response);
		exit();
	}

	public function leerApi()
{
    $file = str_replace(base_url(), '', $_POST['file']);

    // Obtener datos del proveedor incluyendo el campo 'procesar_por'
    $proveedor = $this->Manager_model->getwhere('_proveedores', 'id="' . $_POST['id_proveedor'] . '"');

    // Asegurar de que 'procesar_por' exista si no usar 'local' como valor predeterminado
    $procesar_por = isset($proveedor->procesar_por) ? $proveedor->procesar_por : 'local';

    $request = array(
        'full_path' => $_POST['file']
    );

    // Realizar la llamada a apiRest con el valor de 'procesar_por'
    $dataApi = apiRest($request, $proveedor->urlapi, $procesar_por);

    // Actualizar los datos de la API en la tabla '_datos_api'
    $updateData = array(
        'dato_api' => json_encode($dataApi),
    );

    // Actualizar la base de datos en función del archivo temporal
    $this->db->where("nombre_archivo_temp", $_POST['file']);
    $this->db->update('_datos_api', $updateData);

    // Llamar a otra función (suponiendo que realiza procesamiento adicional, ej: extracción de nro_cuenta)
    $this->getDato($_POST['file'], $proveedor->id);
    
    // --------------------------------------------------------
    // INICIO MANTENIMIENTO: Recálculo de _lotes_resumen
    // 1. Obtener el ID del lote asociado a este archivo recién procesado.
    $file_data = $this->db->select('id_lote')
                          ->get_where('_datos_api', ['nombre_archivo_temp' => $_POST['file']])
                          ->row();
    $id_lote = $file_data ? $file_data->id_lote : null;

    // 2. Llamar a la función de recálculo en Lecturas_model (si se encontró el ID)
    if ($id_lote) {
        // Asegurar que el modelo esté cargado (si no lo está globalmente)
        $this->load->model('Lecturas_model'); 
        
        // Ejecutar el recálculo
        $this->Lecturas_model->actualizar_resumen_lote($id_lote);
    }
    // FIN MANTENIMIENTO
    // --------------------------------------------------------

    // Si el archivo ya ha sido procesado, eliminarlo del servidor
    if (is_file($_POST['file'])) {
        unlink($_POST['file']);
    }

    // Preparar la respuesta final para la solicitud
    $response = array(
        'mensaje' => $_POST['file'],
        'title' => 'LOTES521',
        'status' => 'success',
    );

    // Enviar la respuesta en formato JSON y finalizar la ejecución
    echo json_encode($response);
    exit();
}


	public function upload($id = null)
	{

		if ($this->input->is_ajax_request()) {

			if (!empty($_FILES['file']['name']) && !empty($_POST['id_proveedor'])) {

				$arc = explode('.', $_FILES['file']['name']);
				$nuevoNOmbre = limpiar_caracteres($arc[0]);
				$nombre_archivodb = $nuevoNOmbre . '.' . $arc[1];

				$proveedor = $this->Manager_model->get_data('_proveedores', $_POST['id_proveedor']);
				$nombre_fichero = 'uploader/files/' . strtolower($proveedor->codigo);

				if (!file_exists(strtolower($nombre_fichero))) {
					mkdir($nombre_fichero, 0777, true);
				}

				$data = array();
				// Set preference 
				$uploadPath = $nombre_fichero;
				$config["remove_spaces"] = TRUE;
				$config["overwrite"] = TRUE;
				$config['upload_path'] = $uploadPath;
				//    $config['allowed_types'] = 'jpg|jpeg|png|gif'; 
				$config['allowed_types'] = '*';
				$config['max_size'] = '10000'; // max_size in kb 
				$config['file_name'] = $nombre_archivodb;

				$this->load->library('upload', $config);

				$response = array(
					'mensaje' => 'inico',
					'title' => 'LOTES 562',
					'status' => 'error',
				);

				if ($this->upload->do_upload('file')) {

					$nombre_archivo_temp = $nuevoNOmbre . '_splitter.' . $arc[1];

					$destino = $nombre_fichero  . "/" . $nombre_archivo_temp;

					$this->load->library('pdf_lib');

					$pdf = $this->pdf_lib->test($this->upload->data('full_path'), $destino);

					if (!file_exists(strtolower($nombre_fichero . '/' . $nuevoNOmbre))) {
					}
					try {
						//actrualizo tabla lotes cantidad de archivos
						if (isset($_REQUEST['id_lote'])) {

							$dataLote = array(
								'cant' => $_REQUEST['cant']
							);

							$this->db->where('id', $_REQUEST['id_lote']);
							$this->db->update('_lotes', $dataLote);
						}
					} catch (Exception $e) {

						// this will not catch DB related errors. But it will include them, because this is more general. 
						echo $e->getMessage();
						$response = array(
							'mensaje' => $e->getMessage(),
							'title' => 'Consulta API 218',
							'status' => 'error',
						);
						echo json_encode($response);
						exit();
					}

					$uploadData = $this->upload->data();

					$filename = $uploadData['file_name'];
					$fullpath = $uploadData['full_path'];

					$nombre_archivodb = $config['upload_path'] . '/' . $config['file_name'];

					$lote = $this->Lotes_model->crearLote();

					$texto = ' ';
					$saveData = array(
						'id_lote' => $lote[0]->id,
						'code_lote' => $lote[0]->code,
						'id_proveedor' => $proveedor->id,
						'nombre_proveedor' => $proveedor->nombre,
						'nombre_archivo' => $nombre_archivodb,
						'nombre_archivo_temp' => $destino,
					);

					if ($this->Manager_model->grabar_datos("_datos_api", $saveData)) {


						$response = array(
							'mensaje' => 'Archivo: ' . $filename . ' Lote: ' . $lote[0]->code,
							'title' => 'Grabar Archivos',
							'status' => 'success',
							// 'file' => $filename,
							'file' => $filename,
							'path' => $fullpath,
							'pathw' => $destino,
						);
						echo json_encode($response);
						exit();
					} else {
						$response = array(
							'mensaje' => 'Archivo: ' . $filename . ' Lote: ' . $lote[0]->code,
							'title' => 'Grabar Archivos',
							'status' => 'error',
						);
						echo json_encode($response);
						exit();
					}
				} else {
					// echo 'error ->' . $this->upload->display_errors();
					$data['response'] = 'failed';
					$response = array(
						'mensaje' => 'Archivo: ' . $this->upload->display_errors() . '<br>' . $nombre_archivodb . ' Lote: ' . $_POST['code_lote'],
						'title' => 'Grabar Archivos',
						'status' => 'error',
					);

					echo json_encode($response);
					exit();
				}
			} else {
				$response = array(
					'mensaje' => 'Archivo: vacio',
					'title' => 'Grabar ',
					'status' => 'error',
				);

				echo json_encode($response);
				exit();
			}
		}

		// ACA LLEGA NORMAL

		if (!empty($_POST['id_proveedor'])) {


			$script = array(
				base_url('assets/manager/js/plugins/tables/datatables/datatables.min.js'),
				base_url('assets/manager/js/plugins/dropzone.min.js'),
				//			base_url('assets/manager/js/plugins/tables/datatables/datatables.min.js'),
				//			base_url('assets/manager/js/plugins/tables/datatables/datatables_advanced.js'),
				base_url('assets/manager/js/plugins/forms/selects/select2.min.js'),
				base_url('assets/manager/js/secciones/' . $this->router->fetch_class() . '/' . $this->router->fetch_method() . '.js'),
				// base_url('assets/manager/js/secciones/' . $this->router->fetch_class() . '/datatable.js'),
			);


			$this->data['css_common'] = $this->css_common;
			$this->data['css'] = '';

			$this->data['script_common'] = $this->script_common;
			$this->data['script'] = $script;

			$this->data['proveedor'] = $this->Manager_model->get_data('_proveedores', $_POST['id_proveedor']);


			$this->form_validation->set_rules('id_proveedor', 'proveedor', 'callback_url_check');


			if ($this->form_validation->run() == FALSE) {
				redirect('Admin/Lecturas');
			}

			$hoy = getdate();

			$code = substr(str_replace(array('=', '-', '/s'), '', $this->encrypt->encode($hoy[0])), 0, 6);

			$this->data['code'] = urlencode($code);

			$this->data['dropzone'] = $this->load->view('manager/etiquetas/dropzone', $this->data, TRUE);
			$this->data['content'] = $this->load->view('manager/secciones/lotes/' . $this->router->fetch_method(), $this->data, TRUE);
			$this->load->view('manager/head', $this->data);
			$this->load->view('manager/index', $this->data);
			$this->load->view('manager/footer', $this->data);
		} else {
			die('aca 216');
		}
	}

	public function cerrarLote()
	{
		// Actualizacion tabla _lotes


		$data = array(
			'cant' => $_POST['cant'],
			'status' => 1,

		);
		$data['user_add'] = $this->user->id;
		$this->db->where('id', $_POST['id_lote']);
		$this->db->update('_lotes', $data);
		echo json_encode(array('data' => 'OK'));
	}
	public function crearLote($data = null)
	{
		$lote = $this->Lotes_model->crearLote();

		echo json_encode($this->load->view('manager/etiquetas/panel', $lote, TRUE));
	}

	public function checkFile()
	{
		$arc = explode('.', $_POST['name']);
		$nuevoNOmbre = limpiar_caracteres($arc[0]);
		$nombre_archivodb = $nuevoNOmbre . '.' . $arc[1];

		$proveedor = $this->Manager_model->get_data('_proveedores', $_POST['id_proveedor']);
		$nombre_fichero = 'uploader/files/' . strtolower($proveedor->codigo) . '/' . $nombre_archivodb;

		$datoDb = $this->Manager_model->getWhere('_datos_api', 'nombre_archivo="' . $nombre_archivodb . '"');

		if (file_exists($nombre_fichero)) {

			$response = array(
				"status" => 'error'
			);
			echo json_encode($response);
		} else {
			$response = array(
				"status" => 'success'
			);
			echo json_encode($response);
		};
	}


	public function url_check()
	{
		if ($this->data['proveedor']->urlapi === "") {
			return false;
		}
		return TRUE;
	}




	// En tu controlador (donde estaba la función que me pasaste)

public function lotes_dt($id_proveedor = null) 
{
    if ($this->input->is_ajax_request()) {
        
        // Llama a la nueva función del modelo que devuelve todo el array listo
        $result_array = $this->Lecturas_model->get_lotes_data($id_proveedor);

        // Opcional: Esto ayuda a que el diagnóstico esté al inicio, aunque el modelo ya lo incluye
        $diagnostico = $result_array['diagnostico'];
        unset($result_array['diagnostico']);

        $final_result = [
            "draw" => $result_array['draw'],
            "recordsTotal" => $result_array['recordsTotal'],
            "recordsFiltered" => $result_array['recordsFiltered'],
            "diagnostico" => $diagnostico, // Aseguramos que esté aquí
            "data" => $result_array['data']
        ];
        
        // Output to JSON format
        header('Content-Type: application/json');
        echo json_encode($final_result);
    }
}
	public function deletefile()
	{
		$this->Manager_model->delete();
	}

	public function viewBatch($id = null)
	{
		$data = array();

		$this->lote = $id;

		if ($this->input->is_ajax_request()) {
			// $data = $row = array();

			$LotesData = $this->Lotes_model->getFileRows($_POST);

			$i = $_POST['start'];

			foreach ($LotesData as $r) {

				$classAccionMerge = 'mergefile';
				$archivo = explode('/', $r->nombre_archivo);
				if ($indexador = $this->Manager_model->getWhere('_indexaciones', 'nro_cuenta="' . $r->nro_cuenta . '"')) {
					$indexador = $indexador->id;
				} else {
					$indexador = '0';
				}

				$iconTextMerge = '';

				$disableMerge = '';

				if ($this->Manager_model->get_indexacion('_indexaciones', $r->nro_cuenta)) {

					$iconTextMerge = 'text-success';
				} else {
					$iconTextMerge = 'text-danger';
				}
				if ($r->consolidado == 1) {
					$iconTextMerge = 'text-defautl';
				}

				$accionesVer = '<span class="acciones"><a  title="ver archivo" href="/Admin/Lecturas/Views/' . $r->id . '"  class=""><i class="icon-eye4" title="ver"></i> </a></span> ';
				$accionesCopy = '<span class="acciones"><a data-copy="' . $archivo[3] . '" title="copiar archivo" href="/Admin/Lecturas/Copy/' . $r->id . '"  class=""><i class="icon-copy" title="Copiar archivo"></i> </a></span> ';
				$accionesMerge = '<span data-file="' . $archivo[3] . '" data-consolidado="' . $r->consolidado . '"  data-indexador="' . $indexador . '" data-code="' . $r->code_lote . '" data-id_file="' . $r->id . '" class="' . $classAccionMerge . '"><a ' . $disableMerge . ' title="ver archivo" href="#"  class=""><i class="' . $iconTextMerge . ' icon-merge " title="Consolidar"></i> </a></span> ';
				$accionesReload = '<span data-id_proveedor="' . $r->id_proveedor . '"data-file="' . $r->nombre_archivo_temp . '"data-id_lote="' . $r->id . '" data-code="' . $r->code_lote . '"class="reload-lote acciones" data-consolidado="' . $r->consolidado . '"><a title="Recargar datos API" href="#"  class=""><i class=" text-warningr  fa fa-download" title="Reload"></i> </a> </span>';
				$accionesDelete = '<span data-tabla="_datos_api" data-id_file="' . $r->id . '" class="borrar-file acciones" ><a title="Borrar file" href="#"  class=""><i class=" text-danger icon-trash " title="Borrar "></i> </a> </span>';

				$data[] = array(
					'',
					$r->nro_cuenta,
					$r->nro_medidor,
					$r->nro_factura,
					$r->periodo_del_consumo,
					$r->fecha_emision,
					// fecha_es($r->fecha_emision, 'd/m/a', false),
					// fecha_es($r->vencimiento_del_pago, 'd/m/a', false),
					$r->vencimiento_del_pago,
					$r->total_importe,
					$r->total_vencido,
					$r->consumo,
					$indexador,
					$archivo[3],
					$accionesVer . $accionesCopy . $accionesMerge . $accionesDelete,
					$r->id
				);
			}


			$output = array(
				"draw" => $_POST['draw'],
				"recordsTotal" => $this->Lotes_model->countAllFiles(),
				"recordsFiltered" => $this->Lotes_model->countFilteredFiles($_POST),
				"data" => $data,
			);

			// Output to JSON format
			echo json_encode($output);
			exit();
		}

		if ($id) {


			$script = array(
				base_url('assets\manager\js\plugins\tables\datatables\extensions/select.min.js'),
				base_url('assets/manager/js/plugins/forms/selects/select2.min.js'),
				base_url('assets/manager/js/secciones/' . $this->router->fetch_class() . '/' . $this->router->fetch_method() . '.js'),
				base_url('assets/manager/js/secciones/' . $this->router->fetch_class() . '/modulo.js'),
			);


			$this->data['css_common'] = $this->css_common;
			$this->data['css'] = '';

			$this->data['script_common'] = $this->script_common;
			$this->data['script'] = $script;

			// $this->data['proveedor'] = $this->Manager_model->get_data('_proveedores', $_POST['id_proveedor']);



			$hoy = getdate();
			$code = substr(str_replace(array('=', '-'), '', $this->encrypt->encode($hoy[0])), 0, -22);

			$this->data['code'] = $code;

			$this->data['dropzone'] = $this->load->view('manager/etiquetas/dropzone', $this->data, TRUE);
			$this->data['content'] = $this->load->view('manager/secciones/lotes/' . $this->router->fetch_method(), $this->data, TRUE);
			$this->load->view('manager/head', $this->data);
			$this->load->view('manager/index', $this->data);
			$this->load->view('manager/footer', $this->data);
		}
	}

	public function views($id)
	{
		// $myDato = $this->encrypt->decode(urldecode($id));
		$myDato = $id;

		$registro_api = $this->Manager_model->get_data_api('_datos_api', $myDato);

		$script = array(
			base_url('assets/manager/js/plugins/tables/datatables/datatables.js'),
			base_url('assets/manager/js/plugins/dropzone.min.js'),
			base_url('assets/manager/js/secciones/lecturas/views.js?ver=' . time()),
		);

		$this->data['css_common'] = $this->css_common;
		$this->data['css'] = '';

		$this->data['script_common'] = $this->script_common;
		$this->data['script'] = $script;
		$this->data['result'] = $registro_api;


		// $this->data['nro_cuenta'] = $resultData->nro_cuenta;

		$this->data['indexaciones'] = $this->Indexaciones_model->get_indexaciones($registro_api->nro_cuenta);

		$this->data['content'] = $this->load->view('manager/secciones/' . strtolower($this->router->fetch_class()) . '/' . $this->router->fetch_method(), $this->data, TRUE);

		$this->load->view('manager/head', $this->data);
		$this->load->view('manager/index', $this->data);
		$this->load->view('manager/footer', $this->data);
	}
	public function listados()
	{
		$script = array(
			base_url('assets/manager/js/plugins/tables/datatables/datatables.js'),
			base_url('assets/manager/js/plugins/dropzone.min.js'),
			//			base_url('assets/manager/js/plugins/tables/datatables/datatables.min.js'),
			//			base_url('assets/manager/js/plugins/tables/datatables/datatables_advanced.js'),
			base_url('assets/manager/js/plugins/forms/selects/select2.min.js'),
			base_url('assets/manager/js/secciones/' . $this->router->fetch_class() . '/' . $this->router->fetch_method() . '.js'),
		);


		$this->data['css_common'] = $this->css_common;
		$this->data['css'] = '';

		$this->data['script_common'] = $this->script_common;
		$this->data['script'] = $script;
		$this->data['select_proveedores'] = $this->Manager_model->obtener_contenido_select('_proveedores', 'SELECCIONE PROVEEDOR', 'nombre', 'id ASC');

		$this->data['content'] = $this->load->view('manager/secciones/Lotes/' . $this->router->fetch_method(), $this->data, TRUE);

		$this->load->view('manager/head', $this->data);
		$this->load->view('manager/index', $this->data);
		$this->load->view('manager/footer', $this->data);
	}

	public function agregar()
	{

		$this->data['css_common'] = $this->css_common;
		$this->data['css'] = '';

		$script = array(
			base_url('assets/manager/js/plugins/forms/selects/select2.min.js'),
			base_url('assets/manager/js/plugins/forms/styling/uniform.min.js'),
			base_url('assets/manager/js/secciones/' . $this->router->fetch_class() . '/' . $this->router->fetch_method() . '.js'),
			// base_url('assets/manager/js/secciones/'.$this->router->fetch_class().'.js'),
		);
		$this->data['script_common'] = $this->script_common;
		$this->data['script'] = $script;


		$this->form_validation->set_rules('username', 'Username', 'trim|required|callback_check_username');
		$this->form_validation->set_rules('first_name', 'Nombre', 'trim|required');
		$this->form_validation->set_rules('last_name', 'Apellido', 'trim|required');
		// $this->form_validation->set_rules('password', 'Password', 'trim|required');
		//$this->form_validation->set_rules('password_2', 'Password Confirmación', 'trim|required|matches[password]');
		$this->form_validation->set_rules('email', 'Email', 'trim|required|callback_check_email');
		$this->form_validation->set_rules('grupos[]', 'Seleccione un Grupo', 'required');
		if ($this->form_validation->run() == FALSE) {


			$this->data['content'] = $this->load->view('manager/secciones/usuarios/' . $this->router->fetch_method(), $this->data, TRUE);

			$this->load->view('manager/head', $this->data);
			$this->load->view('manager/index', $this->data);
			$this->load->view('manager/footer', $this->data);
		} else {

			$groups = array();
			foreach ($this->input->post('grupos') as $key => $value) {
				array_push($groups, $value);
			}


			$additional_data = array(
				'first_name' => $this->input->post('first_name'),
				'last_name' => $this->input->post('last_name'),
			);

			$this->ion_auth->register($this->input->post('username'), $this->input->post('password'), $this->input->post('email'), $additional_data, $groups);
			redirect(base_url('Manager/secciones/usuarios/usuarios/'));
		}
	}

	// functiones callback validacion de formularios

	// --- FUNCIONES AUXILIARES ---

private function getValor($obj, $campo, $tipo = 'string') {
    if (!isset($obj->$campo)) return ($tipo === 'number') ? '0.00' : 'S/D';
    
    switch ($tipo) {
        case 'string':
            return trim($obj->$campo->valueString ?? $obj->$campo->content ?? 'S/D');
        case 'number':
            return number_format($obj->$campo->valueNumber ?? 0, 2, '.', '');
        case 'date':
            return trim($obj->$campo->valueDate ?? 'S/D');
        default:
            return 'S/D';
    }
}

private function formatearCuenta($raw) {
    $cuenta_limpia = preg_replace('/^\(\d+\)/', '', trim($raw));
    if ($cuenta_limpia === '') return 'S/D';
    return (strlen($cuenta_limpia) > 4)
        ? substr($cuenta_limpia, 0, -4) . '-' . substr($cuenta_limpia, -4)
        : $cuenta_limpia;
}
private function procesarProveedorTelecomFija($fields) {
    $totalImporte = $this->getValor($fields, 'total_importe', 'number');
    $fechaEmision = $this->getValor($fields, 'fecha_emision', 'date'); // Obtener la fecha de emisión

    // Calcular mes_fc y anio_fc
    // ASUMIMOS que $this->getMesAnioDesdeFecha existe y es accesible en esta clase.
    $mesAnioData = $this->getMesAnioDesdeFecha($fechaEmision);

    // Extraer el campo 'proximo_vencimiento'
    // Accedemos directamente a valueDate si 'proximo_vencimiento' existe,
    // de lo contrario, devolvemos 'S/D' o un valor predeterminado apropiado.
    $proximoVencimiento = $fields->proximo_vencimiento->valueDate ?? 'S/D';


    return [
        'nro_cuenta'           => $this->formatearCuenta($fields->nro_cuenta->content ?? ''),
        'nro_medidor'          => 'N/A',
        'nro_factura'          => $this->getValor($fields, 'numero_de_factura'),
        'fecha_emision'        => $fechaEmision, // Usar la variable ya obtenida
        'vencimiento_del_pago' => $this->getValor($fields, 'vencimiento_del_pago', 'date'),
        'periodo_del_consumo'  => $this->getValor($fields, 'periodo_facturado'),
        'total_vencido'        => $this->getValor($fields, 'cargo_mes', 'number'),
        'total_importe'        => $totalImporte,
        'importe_1'            => is_numeric($totalImporte) ? number_format((float)$totalImporte, 2, '.', '') : 0.00,
        'consumo'              => $this->getValor($fields, 'consumo'),
        'mes_fc'               => $mesAnioData['mes_fc'],
        'anio_fc'              => $mesAnioData['anio_fc'],
        'proximo_vencimiento'  => $proximoVencimiento, // ¡Nuevo campo agregado!
    ];
}
// --- FUNCIÓN AUXILIAR en el controlador lotes.php ---
// (Asegúrate de que esta función esté dentro de tu clase Lotes.php, no en un helper global)

private function getMesAnioDesdeFecha(string $fechaStr): array
{
    // Si la fecha es 'S/D' o vacía, devolvemos valores por defecto
    if (empty($fechaStr) || $fechaStr === 'S/D') {
        return ['mes_fc' => 'S/D', 'anio_fc' => 'S/D'];
    }

    // Intenta parsear como 'YYYY-MM-DD' (formato estándar de DB y muchas APIs)
    $fechaObjeto = DateTime::createFromFormat('Y-m-d', $fechaStr);

    // Si falló, intenta parsear como 'DD/MM/YYYY' (común en documentos y algunas APIs)
    if ($fechaObjeto === false) {
        $fechaObjeto = DateTime::createFromFormat('d/m/Y', $fechaStr);
    }

    // Si aún no se pudo parsear, registra un error y devuelve S/D
    if ($fechaObjeto === false) {
       // error_log("Error: Formato de fecha no reconocido por getMesAnioDesdeFecha: " . $fechaStr);
        return ['mes_fc' => 'S/D', 'anio_fc' => 'S/D'];
    }

    // Extraer y retornar el mes (con cero inicial) y el año
    return [
        'mes_fc' => $fechaObjeto->format('m'), // 'm' para mes con cero inicial (01-12)
        'anio_fc' => $fechaObjeto->format('Y')  // 'Y' para año completo (ej. 2023)
    ];
}


}
